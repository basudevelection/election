<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register as Voter</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body onload="populateProvinces()">
  <div class="container">
    <h1>Register as Voter</h1>
    <div id="msg"></div>
    <form onsubmit="event.preventDefault(); registerVoter()">
      <div class="form-section">
        <input type="text" id="fullName" placeholder="Full Name (as per citizenship)" required />
        <label>Date of Birth:</label>
        <input type="date" id="dob" required />
        <select id="gender" required>
          <option value="">Gender</option>
          <option>Male</option>
          <option>Female</option>
          <option>Others</option>
        </select>
        <input type="text" id="citizenshipNo" placeholder="Citizenship Number" required />
        <label>Address:</label>
        <select id="province" onchange="populateDistricts()" required>
          <option value="">Select Province</option>
        </select>
        <select id="district" onchange="populateMunicipalities()" required>
          <option value="">Select District</option>
        </select>
        <select id="municipality" required>
          <option value="">Select Municipality</option>
        </select>
        <input type="text" id="tole" placeholder="Tole / Street Name" required />
        <input type="number" id="ward" placeholder="Ward Number" required />
        <input type="tel" id="contact" placeholder="Contact Number" required />
        <input type="email" id="email" placeholder="Email Address" required />
        <label>Voter ID Photo (front):</label>
        <input type="file" id="voterPhoto" accept="image/*" required />
      </div>
      <button type="submit" class="btn">Register</button>
    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="script.js"></script>
  <script>
    async function registerVoter() {
      const required = ['fullName', 'dob', 'gender', 'citizenshipNo', 'province', 'district', 'municipality', 'tole', 'ward', 'contact', 'email', 'voterPhoto'];
      for (let id of required) {
        if (!document.getElementById(id).value) return showMsg('msg', `Missing: ${id}`, 'error');
      }
      const photoFile = document.getElementById('voterPhoto').files[0];
      let photoUrl = '';
      if (photoFile) {
        const { data, error } = await supabase.storage.from('photos').upload(`voters/${Date.now()}_${photoFile.name}`, photoFile);
        if (error) return showMsg('msg', error.message, 'error');
        photoUrl = supabase.storage.from('photos').getPublicUrl(data.path).data.publicUrl;
      }
      const voterId = 'V' + Math.random().toString(36).substr(2, 9).toUpperCase();
      const { error } = await supabase.from('voters').insert({
        voter_id: voterId,
        full_name: document.getElementById('fullName').value,
        birth_date: document.getElementById('dob').value,
        gender: document.getElementById('gender').value,
        citizenship_no: document.getElementById('citizenshipNo').value,
        location: {
          province: document.getElementById('province').value,
          district: document.getElementById('district').value,
          municipality: document.getElementById('municipality').value,
          tole: document.getElementById('tole').value,
          ward: document.getElementById('ward').value
        },
        contact: document.getElementById('contact').value,
        email: document.getElementById('email').value,
        photo_url: photoUrl
      });
      if (error) return showMsg('msg', error.message, 'error');
      showMsg('msg', `Voter registered! Your Voter ID is: ${voterId}. Save this ID to vote.`, 'success');
      document.querySelector('form').reset();
    }
  </script>
</body>
</html>
