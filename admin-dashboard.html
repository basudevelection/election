<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .admin-container { max-width: 1200px; margin: 0 auto; padding: 20px; background: linear-gradient(to bottom, #f0f4f8, #d9e2ec); border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    .admin-header { text-align: center; margin-bottom: 30px; }
    .admin-nav { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .admin-tab { display: none; }
    .admin-tab.active { display: block; }
    .admin-table { width: 100%; border-collapse: collapse; }
    .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 8px; }
    .admin-table th { background: #f4f4f4; }
    .admin-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin: 2px; }
    .approve-btn { background: #4caf50; color: white; }
    .delete-btn { background: #f44336; color: white; }
    .edit-btn { background: #2196f3; color: white; }
    .publish-btn { background: #ff9800; color: white; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
</head>
<body onload="loadAdminData()">
  <div class="admin-container">
    <div class="admin-header">
      <h1>Admin Dashboard</h1>
      <p>Complete control over elections</p>
      <button class="admin-btn delete-btn" onclick="logout()">Logout</button>
    </div>
    <div class="admin-nav">
      <button onclick="openAdminTab('elections')" class="active">Elections</button>
      <button onclick="openAdminTab('voters')">Voters</button>
      <button onclick="openAdminTab('candidates')">Candidates</button>
      <button onclick="openAdminTab('votes')">Votes</button>
      <button onclick="openAdminTab('results')">Results</button>
    </div>
    
    <div id="elections" class="admin-tab active">
      <h2>Elections Management</h2>
      <div style="background:white; padding:15px; border-radius:8px; margin-bottom:20px;">
        <input type="text" id="newElectionName" placeholder="Election Name" style="width:30%; margin-right:10px;">
        <input type="date" id="newStartDate" style="width:20%; margin-right:10px;">
        <input type="date" id="newNomEnd" style="width:20%; margin-right:10px;">
        <input type="date" id="newVoteEnd" style="width:20%;">
        <button class="admin-btn approve-btn" onclick="createElection()" style="width:auto;">Create Election</button>
      </div>
      <table class="admin-table">
        <thead><tr><th>Name</th><th>Start</th><th>Nom End</th><th>Vote End</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="electionsTable"></tbody>
      </table>
    </div>

    <div id="voters" class="admin-tab">
      <h2>Voters Management</h2>
      <table class="admin-table">
        <thead><tr><th>Name</th><th>Voter ID</th><th>DOB</th><th>Citizenship</th><th>Approved</th><th>Actions</th></tr></thead>
        <tbody id="votersTable"></tbody>
      </table>
    </div>

    <div id="candidates" class="admin-tab">
      <h2>Candidates Management</h2>
      <table class="admin-table">
        <thead><tr><th>Name</th><th>Party</th><th>Position</th><th>Approved</th><th>Actions</th></tr></thead>
        <tbody id="candidatesTable"></tbody>
      </table>
    </div>

    <div id="votes" class="admin-tab">
      <h2>Votes Management</h2>
      <table class="admin-table">
        <thead><tr><th>Voter ID</th><th>Candidate</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="votesTable"></tbody>
      </table>
    </div>

    <div id="results" class="admin-tab">
      <h2>Results Management</h2>
      <table class="admin-table">
        <thead><tr><th>Election</th><th>Results Published</th><th>Actions</th></tr></thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </div>
  </div>
  <script>
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken || !adminToken.startsWith('admin-auth-')) {
      location.href = 'admin-login.html';
    }

    function logout() {
      localStorage.removeItem('adminToken');
      location.href = 'admin-login.html';
    }

    function openAdminTab(tabName) {
      document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.admin-nav button').forEach(b => b.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`button[onclick="openAdminTab('${tabName}')"]`).classList.add('active');
    }

    async function loadAdminData() {
      await loadElectionsAdmin();
      await loadVotersAdmin();
      await loadCandidatesAdmin();
      await loadVotesAdmin();
      await loadResultsAdmin();
    }

    async function loadElectionsAdmin() {
      const { data } = await supabase.from('elections').select('*').order('created_at', { ascending: false });
      document.getElementById('electionsTable').innerHTML = data.map(e => `
        <tr>
          <td>${e.name}</td>
          <td>${formatDate(e.start_date)}</td>
          <td>${formatDate(e.nomination_end)}</td>
          <td>${formatDate(e.voting_end)}</td>
          <td>${e.status}</td>
          <td>
            <button class="admin-btn edit-btn" onclick="editElection('${e.id}')">Edit</button>
            <button class="admin-btn delete-btn" onclick="deleteElection('${e.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function createElection() {
      const name = document.getElementById('newElectionName').value;
      const start = document.getElementById('newStartDate').value;
      const nom = document.getElementById('newNomEnd').value;
      const vote = document.getElementById('newVoteEnd').value;
      if (!name || !start || !nom || !vote) return alert('Fill all fields');
      await supabase.from('elections').insert({ name, start_date: start, nomination_end: nom, voting_end: vote });
      loadElectionsAdmin();
      alert('Election created!');
    }

    async function loadVotersAdmin() {
      const { data } = await supabase.from('voters').select('*');
      document.getElementById('votersTable').innerHTML = data.map(v => `
        <tr>
          <td>${v.full_name}</td>
          <td>${v.voter_id}</td>
          <td>${v.birth_date}</td>
          <td>${v.citizenship_no}</td>
          <td>${v.approved ? 'Yes' : 'No'}</td>
          <td>
            <button class="admin-btn ${v.approved ? 'delete-btn' : 'approve-btn'}" onclick="${v.approved ? 'unapproveVoter' : 'approveVoter'}('${v.id}')">
              ${v.approved ? 'Unapprove' : 'Approve'}
            </button>
            <button class="admin-btn delete-btn" onclick="deleteVoter('${v.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function approveVoter(id) {
      await supabase.from('voters').update({ approved: true }).eq('id', id);
      loadVotersAdmin();
    }

    async function unapproveVoter(id) {
      await supabase.from('voters').update({ approved: false }).eq('id', id);
      loadVotersAdmin();
    }

    async function deleteVoter(id) {
      if (confirm('Delete voter?')) {
        await supabase.from('voters').delete().eq('id', id);
        loadVotersAdmin();
      }
    }

    async function loadCandidatesAdmin() {
      const { data } = await supabase.from('candidates').select('*');
      document.getElementById('candidatesTable').innerHTML = data.map(c => `
        <tr>
          <td>${c.full_name}</td>
          <td>${c.party}</td>
          <td>${c.position_contested}</td>
          <td>${c.approved ? 'Yes' : 'No'}</td>
          <td>
            <button class="admin-btn ${c.approved ? 'delete-btn' : 'approve-btn'}" onclick="${c.approved ? 'unapproveCandidate' : 'approveCandidate'}('${c.id}')">
              ${c.approved ? 'Unapprove' : 'Approve'}
            </button>
            <button class="admin-btn delete-btn" onclick="deleteCandidate('${c.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function approveCandidate(id) {
      await supabase.from('candidates').update({ approved: true }).eq('id', id);
      loadCandidatesAdmin();
    }

    async function unapproveCandidate(id) {
      await supabase.from('candidates').update({ approved: false }).eq('id', id);
      loadCandidatesAdmin();
    }

    async function deleteCandidate(id) {
      if (confirm('Delete candidate?')) {
        await supabase.from('candidates').delete().eq('id', id);
        loadCandidatesAdmin();
      }
    }

    async function loadVotesAdmin() {
      const { data } = await supabase.from('votes').select(`
        *,
        candidates(full_name, party),
        voters(full_name)
      `);
      document.getElementById('votesTable').innerHTML = data.map(v => `
        <tr>
          <td>${v.voter_id}</td>
          <td>${v.candidates.full_name} (${v.candidates.party})</td>
          <td>${v.created_at}</td>
          <td><button class="admin-btn delete-btn" onclick="deleteVote('${v.id}')">Delete</button></td>
        </tr>
      `).join('');
    }

    async function deleteVote(id) {
      if (confirm('Delete vote?')) {
        await supabase.from('votes').delete().eq('id', id);
        loadVotesAdmin();
      }
    }

    async function loadResultsAdmin() {
      const { data } = await supabase.from('elections').select('*');
      document.getElementById('resultsTable').innerHTML = data.map(e => `
        <tr>
          <td>${e.name}</td>
          <td>${e.result_approved ? 'Yes' : 'No'}</td>
          <td>
            <button class="admin-btn ${e.result_approved ? 'delete-btn' : 'publish-btn'}" onclick="${e.result_approved ? 'unpublishResult' : 'publishResult'}('${e.id}')">
              ${e.result_approved ? 'Unpublish' : 'Publish Results'}
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function publishResult(id) {
      await supabase.from('elections').update({ result_approved: true }).eq('id', id);
      loadResultsAdmin();
    }

    async function unpublishResult(id) {
      await supabase.from('elections').update({ result_approved: false }).eq('id', id);
      loadResultsAdmin();
    }

    async function editElection(id) {
      const name = prompt('New election name:');
      if (name) {
        await supabase.from('elections').update({ name }).eq('id', id);
        loadElectionsAdmin();
      }
    }

    async function deleteElection(id) {
      if (confirm('Delete election and all related data?')) {
        await supabase.from('votes').delete().eq('election_id', id);
        await supabase.from('candidates').delete().eq('election_id', id);
        await supabase.from('voters').delete().eq('election_id', id);
        await supabase.from('elections').delete().eq('id', id);
        loadElectionsAdmin();
      }
    }
  </script>
</body>
</html>
