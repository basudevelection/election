<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proceed to Vote</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="script.js"></script>
</head>
<body onload="loadElection()">
  <div class="container">
    <h1>Proceed to Vote</h1>
    <div id="msg"></div>
    <div class="form-section">
      <input type="text" id="voterId" placeholder="Enter 10-digit Voter ID" required />
      <button class="btn" onclick="verifyVoter()">Verify & Load Candidates</button>
    </div>
    <div id="voteSection" class="form-section hidden">
      <h3>Select Candidate</h3>
      <div id="candidateList" class="grid"></div>
      <button class="btn" onclick="submitVote()">Submit Vote</button>
    </div>
  </div>
  <script>
    async function verifyVoter() {
      const vid = document.getElementById('voterId').value.trim();
      if (vid.length !== 10 || !/^\d+$/.test(vid)) {
        return showMsg('msg', 'Please enter a valid 10-digit Voter ID', 'error');
      }
      const { data: voter } = await supabase
        .from('voters')
        .select('approved')
        .eq('voter_id', vid)
        .eq('election_id', getUrlParam('eid'))
        .single();
      if (!voter || !voter.approved) {
        return showMsg('msg', 'Voter ID not found or not approved', 'error');
      }
      const { data: vote } = await supabase
        .from('votes')
        .select('*')
        .eq('voter_id', vid)
        .eq('election_id', getUrlParam('eid'))
        .single();
      if (vote) {
        return showMsg('msg', 'You have already voted in this election', 'error');
      }
      document.getElementById('voteSection').classList.remove('hidden');
      loadCandidates();
    }

    async function loadCandidates() {
      const { data, error } = await supabase
        .from('candidates')
        .select('id, full_name, party')
        .eq('election_id', getUrlParam('eid'))
        .eq('approved', true);
      if (error) return showMsg('msg', error.message, 'error');
      const list = document.getElementById('candidateList');
      list.innerHTML = data.map((c, i) => `
        <div class="card" onclick="selectCandidate('${c.id}', this)">
          <h3>${c.full_name}</h3>
          <p>${c.party}</p>
        </div>
      `).join('');
    }

    let selectedCandidateId = null;
    function selectCandidate(id, el) {
      selectedCandidateId = id;
      document.querySelectorAll('.card').forEach(c => {
        c.style.border = '2px solid #e5e7eb';
        c.style.background = '#fff';
      });
      el.style.border = '3px solid #16a34a';
      el.style.background = '#f0fdf4';
    }

    async function submitVote() {
      if (!selectedCandidateId) return showMsg('msg', 'Please select a candidate', 'error');
      if (!confirm('Are you sure you want to cast this vote?')) return;
      const vid = document.getElementById('voterId').value.trim();
      const { error } = await supabase.from('votes').insert({
        election_id: getUrlParam('eid'),
        voter_id: vid,
        candidate_id: selectedCandidateId
      });
      if (error) return showMsg('msg', error.message, 'error');
      showMsg('msg', 'Vote successfully cast! Thank you for voting.', 'success');
      document.getElementById('voteSection').classList.add('hidden');
    }
  </script>
</body>
</html>
