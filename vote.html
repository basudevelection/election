<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cast Your Vote</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body onload="loadElection(); loadCandidates()">
  <div class="container">
    <h1>Cast Your Vote</h1>
    <div id="msg"></div>
    <form onsubmit="event.preventDefault(); castVote()">
      <div class="form-section">
        <input type="text" id="voterId" placeholder="Your Voter ID (e.g., V123456789)" required />
        <select id="candidate" required>
          <option value="">Select Candidate</option>
        </select>
      </div>
      <button type="submit" class="btn">Submit Vote</button>
    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="script.js"></script>
  <script>
    async function loadCandidates() {
      const { data } = await supabase
        .from('candidates')
        .select('id, data')
        .eq('election_id', getUrlParam('eid'))
        .eq('approved', true);
      const select = document.getElementById('candidate');
      select.innerHTML = '<option value="">Select Candidate</option>' +
        data.map(c => `<option value="${c.id}">${c.data.full_name} (${c.data.party})</option>`).join('');
    }
    async function castVote() {
      const voterId = document.getElementById('voterId').value.trim();
      const candidateId = document.getElementById('candidate').value;
      if (!voterId || !candidateId) return showMsg('msg', 'Please fill all fields', 'error');
      const { data: voter } = await supabase.from('voters').select('id').eq('voter_id', voterId).single();
      if (!voter) return showMsg('msg', 'Invalid Voter ID', 'error');
      const { data: hasVoted } = await supabase
        .from('votes')
        .select('id')
        .eq('voter_id', voterId)
        .eq('election_id', getUrlParam('eid'))
        .single();
      if (hasVoted) return showMsg('msg', 'You have already voted in this election', 'error');
      const { error } = await supabase.from('votes').insert({
        voter_id: voterId,
        candidate_id: candidateId,
        election_id: getUrlParam('eid')
      });
      if (error) return showMsg('msg', error.message, 'error');
      showMsg('msg', 'Vote cast successfully!', 'success');
      document.querySelector('form').reset();
    }
  </script>
</body>
</html>
